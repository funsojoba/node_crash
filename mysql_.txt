
CREATE OR REPLACE VIEW V_SESSION_STATS_HOURLY_TREND AS
SELECT DATE_FORMAT(a.START_TIME, '%Y-%m-%d') AS DATE_KEY,
       DATE_FORMAT(a.START_TIME, '%H') AS HOUR,
       COUNT(a.ID) AS SESSION_COUNTS
FROM USSD_SESSION a
WHERE DATE(a.START_TIME) = CURDATE()
GROUP BY DATE_FORMAT(a.START_TIME, '%Y-%m-%d'), DATE_FORMAT(a.START_TIME, '%H')
ORDER BY HOUR;






CREATE OR REPLACE VIEW V_MENU_SERVICE_STATS_WEEKLY AS
SELECT DATE_FORMAT(DATE(a.REQUEST_DATE_TIME), '%Y-%m-%d') AS DATE_KEY,
       a.SHORT_CODE,
       a.FEATURE AS SCREEN_ID,
       CONCAT(b.SHORT_CODE, '-', a.FEATURE) AS feature,
       COUNT(1) AS SCREEN_COUNTS
FROM USSD_REQUEST a
JOIN USSD_SESSION b ON (a.SESSION_ID = b.id AND DATE(a.REQUEST_DATE_TIME) = DATE(b.START_TIME))
WHERE DATE(a.REQUEST_DATE_TIME) BETWEEN CURDATE() - INTERVAL 7 DAY AND CURDATE()
AND SCREEN_ID IN (
    SELECT screen_id FROM (
        SELECT SCREEN_ID AS SCREEN_ID
        FROM USSD_REQUEST
        WHERE DATE(a.REQUEST_DATE_TIME) BETWEEN CURDATE() - INTERVAL 7 DAY AND CURDATE() 
        GROUP BY SCREEN_ID
        ORDER BY COUNT(1) DESC
        LIMIT 10
    ) AS subquery
)
AND UPPER(a.feature) NOT IN ('WELCOME', 'HOME')
AND UPPER(a.FEATURE) NOT LIKE '%SUCCESS%'
AND UPPER(a.FEATURE) NOT LIKE '%FAILURE%'
GROUP BY DATE(a.REQUEST_DATE_TIME), b.SHORT_CODE, a.FEATURE 
ORDER BY DATE(a.REQUEST_DATE_TIME) DESC;





CREATE OR REPLACE VIEW V_MENU_SERVICE_STATS_HOURLY_TREND AS
SELECT DATE_FORMAT(a.REQUEST_DATE_TIME, '%Y-%m-%d') AS DATE_KEY,
       DATE_FORMAT(a.REQUEST_DATE_TIME, '%H') AS HOUR,
       COUNT(a.ID) AS REQUEST_COUNTS
FROM USSD_REQUEST a
WHERE DATE(a.REQUEST_DATE_TIME) = CURDATE()
GROUP BY DATE_FORMAT(a.REQUEST_DATE_TIME, '%Y-%m-%d'), DATE_FORMAT(a.REQUEST_DATE_TIME, '%H')
ORDER BY DATE_FORMAT(a.REQUEST_DATE_TIME, '%H') ASC;






CREATE OR REPLACE VIEW V_MENU_SERVICE_FULFILLED_STATS_WEEKLY AS
SELECT DATE_FORMAT(DATE(a.REQUEST_DATE_TIME), '%Y-%m-%d') AS DATE_KEY,
       a.SHORT_CODE,
       a.FEATURE AS SCREEN_ID,
       CONCAT(b.SHORT_CODE, '-', a.FEATURE) AS feature,
       COUNT(1) AS SCREEN_COUNTS
FROM USSD_REQUEST a
JOIN USSD_SESSION b ON (a.SESSION_ID = b.id AND DATE(a.REQUEST_DATE_TIME) = DATE(b.START_TIME))
WHERE DATE(a.REQUEST_DATE_TIME) BETWEEN CURDATE() - INTERVAL 7 DAY AND CURDATE()
AND SCREEN_ID IN (
    SELECT screen_id FROM (
        SELECT SCREEN_ID AS SCREEN_ID
        FROM USSD_REQUEST a
        WHERE DATE(a.REQUEST_DATE_TIME) BETWEEN CURDATE() - INTERVAL 7 DAY AND CURDATE()
        AND (UPPER(a.feature) LIKE '%SUCCESS%' OR UPPER(a.feature) LIKE '%FAILURE%')
        GROUP BY SCREEN_ID
        ORDER BY COUNT(1) DESC
        LIMIT 10
    ) AS subquery
)
AND UPPER(a.feature) NOT IN ('WELCOME', 'HOME')
AND (UPPER(a.feature) LIKE '%SUCCESS%' OR UPPER(a.feature) LIKE '%FAILURE%')
GROUP BY DATE(a.REQUEST_DATE_TIME), b.SHORT_CODE, a.FEATURE 
ORDER BY DATE(a.REQUEST_DATE_TIME) DESC;

